# 法條考題智能對應系統 - 使用說明書

## 📋 目錄

1. [系統概述](#系統概述)
2. [安裝指南](#安裝指南)
3. [系統配置](#系統配置)
4. [基本使用](#基本使用)
5. [進階功能](#進階功能)
6. [API 參考](#api-參考)
7. [故障排除](#故障排除)
8. [最佳實踐](#最佳實踐)

---

## 🎯 系統概述

法條考題智能對應系統是一個基於 LLM 的智能分析工具，能夠：

- **自動分析考試題目**與相關法規條文的對應關係
- **智能解析選擇題選項**的法源依據
- **生成詳細的對應報告**供後續分析使用
- **支援多種 LLM 提供者**（OpenAI、Claude、本地模型等）

### 系統架構

```
📁 LegalStatuteAnalysis/
├── 📁 src/                    # 核心代碼
│   ├── 📁 models/            # 資料模型
│   ├── 📁 services/          # 服務層
│   └── 📁 parsing/           # LLM 解析器
├── 📁 scripts/               # 執行腳本
├── 📁 results/               # 輸出結果
├── 📁 data/                  # 原始資料
└── 📄 law_config.json        # 系統配置
```

---

## 🚀 安裝指南

### 系統需求

- **Python**: 3.8 以上
- **作業系統**: Windows 10/11, Linux, macOS
- **記憶體**: 建議 4GB 以上
- **硬碟空間**: 至少 500MB

### 1. 克隆專案

```bash
git clone <repository_url>
cd LegalStatuteAnalysis
```

### 2. 創建虛擬環境

```bash
# Windows
python -m venv venv
venv\Scripts\activate

# Linux/macOS  
python -m venv venv
source venv/bin/activate
```

### 3. 安裝依賴

```bash
pip install -r requirements.txt
```

**主要依賴套件**：
- `mineru[core]>=2.1.0` - PDF 解析和處理
- `rich==13.7.0` - 美化終端輸出
- `langchain` - LLM 調用框架
- `langchain-openai` - OpenAI 整合
- `python-dotenv` - 環境變數管理
- `pandas` - 資料處理
- `asyncio` - 異步處理支援

### 4. 環境變數設定

創建 `.env` 文件：

```env
# OpenAI API (如果使用)
OPENAI_API_KEY=your_openai_api_key_here

# Claude API (如果使用)
ANTHROPIC_API_KEY=your_claude_api_key_here

# LLM 提供者選擇
LLM_PROVIDER=simulation  # simulation | openai | claude | local
```

### 5. 驗證安裝

```bash
# 測試基本功能
python scripts/test_model_mapper.py --provider simulation --limit 1

# 預期輸出
✅ 所有測試通過！新的資料模型架構運作正常。
```

如果看到上述訊息，表示安裝成功！

---

## ⚙️ 系統配置

### 主配置文件 (`law_config.json`)

```json
{
  "version": "3.0",
  "description": "法規與考題解析設定檔 - LLM 驅動版本",
  "law_definitions": {
    "不動產經紀業管理條例.md": {
      "law_code": "REA-ACT",
      "law_name": "不動產經紀業管理條例",
      "revision_date_roc": "民國 110 年 01 月 27 日",
      "category": "不動產經紀",
      "authority": "內政部"
    }
  },
  "exam_sets": {
    "113_real_estate_gaokao": {
      "name": "113年專門職業及技術人員高等考試",
      "year": 113,
      "question_file": "results/mineru_batch/113190_60150(5601).md",
      "answer_file": "results/mineru_batch/113190_ANS5601.md",
      "output_file": "results/exam_113_complete.json",
      "parser_type": "llm"
    }
  },
  "llm_config": {
    "default_provider": "openai",
    "fallback_provider": "simulation",
    "providers": {
      "openai": {
        "model": "gpt-4o-mini",
        "temperature": 0,
        "max_tokens": 4000,
        "api_key_env": "OPENAI_API_KEY"
      },
      "simulation": {
        "model": "sim-v1",
        "description": "本地模擬器，用於測試"
      }
    }
  }
}
```

### 配置說明

| 區段 | 用途 | 必填 |
|------|------|------|
| `law_definitions` | 定義法規條文的基本資訊 | ✅ |
| `exam_sets` | 定義考試集和文件路徑 | ✅ |
| `llm_config` | LLM 提供者和模型設定 | ✅ |
| `output_settings` | 輸出格式和編碼設定 | ❌ |

---

## 💻 基本使用

### 1. 快速開始

使用模擬模式（無需 API 金鑰）：

```bash
python src/main_mapper.py --provider simulation --limit 5
```

**預期輸出**：
```
🎯 法條考題智能對應系統 - 資料模型版本
============================================================

📋 載入系統配置: law_config.json
✅ 系統配置載入完成 (版本: 3.0)

🛠️ 初始化對應服務...
✅ 成功載入 269 條法規條文
🔍 建立法條搜尋索引，共 269 條法規

🤖 開始分析 (LLM: simulation)
   限制處理題目數: 5
✅ 成功載入 27 道考試題目
   - 申論題: 2 道
   - 選擇題: 25 道

🚀 開始批次處理 5 道題目
✅ 題目 1 分析完成 (信心度: 0.600, 耗時: 0.18s)
✅ 題目 2 分析完成 (信心度: 0.750, 耗時: 0.12s)
...

📊 分析結果統計
   處理題目數: 5
   平均信心度: 0.680
   高信心度題目: 3 / 5
   整體成功率: 60.0%
   報告文件: results/mapping_report_model_based.json

✅ 分析完成！
```

### 2. 使用真實 LLM

```bash
# 使用 OpenAI
python src/main_mapper.py --provider openai --limit 10

# 使用 Claude  
python src/main_mapper.py --provider claude --limit 10
```

### 3. 完整分析

```bash
# 分析所有題目
python src/main_mapper.py --provider openai
```

### 4. 自定義輸出

```bash
python src/main_mapper.py \
  --provider openai \
  --limit 20 \
  --config my_config.json \
  --output results/my_analysis.json
```

---

## 🔄 完整工作流程示例

### 從 PDF 到分析報告的完整流程

```bash
# 1. 準備 PDF 文件 (放置在 data/ 目錄)
ls data/*.pdf

# 2. 使用 MinerU 解析 PDF (如果需要)
python scripts/convert_pdf.py

# 3. 運行 LLM 解析器處理考題
python scripts/run_llm_parsing.py \
  --questions_file "results/mineru_batch/113190_60150(5601).md" \
  --answers_file "results/mineru_batch/113190_ANS5601.md" \
  --output_file "results/exam_113_complete_llm_improved.json"

# 4. 轉換法條資料為 CSV 格式  
python scripts/law_articles_converter.py

# 5. 執行智能對應分析
python src/main_mapper.py --provider openai --limit 20

# 6. 檢視分析結果
python -c "
import json
with open('results/mapping_report_model_based.json', 'r', encoding='utf-8') as f:
    data = json.load(f)
print(f'總題目數: {data[\"metadata\"][\"total_questions\"]}')
print(f'平均信心度: {data[\"metadata\"][\"average_confidence\"]:.3f}')
print(f'成功率: {data[\"metadata\"][\"success_rate\"]:.1%}')
"
```

---

## 🔧 進階功能

### 1. 批次處理考題

```python
from src.models import SystemConfig
from src.services import MappingService
import asyncio

async def batch_analysis():
    config = SystemConfig.load_from_file()
    
    async with MappingService(config) as service:
        await service.initialize_llm("openai")
        
        # 分析特定題目
        questions = service.data_repo.exam_questions[0:10]
        mappings = await service.process_questions(questions)
        
        # 生成報告
        report = service.generate_report(mappings)
        report.save_to_file("custom_report.json")

asyncio.run(batch_analysis())
```

### 2. 自定義 LLM 配置

```python
from src.models import LLMConfig, LLMProvider
from src.services import LLMService

# 自定義配置
llm_config = LLMConfig(
    provider=LLMProvider.OPENAI,
    model="gpt-4",
    temperature=0.1,
    max_tokens=2000
)

# 使用自定義配置
async with LLMService(llm_config) as service:
    result = await service.analyze_question_articles(
        question_content="題目內容",
        candidate_articles="候選法條"
    )
```

### 3. 資料載入和預處理

```python
from src.models import LawArticleLoader, ExamQuestionLoader

# 載入法條資料
articles = LawArticleLoader.load_from_csv("results/law_articles.csv")

# 載入考題資料  
questions = ExamQuestionLoader.load_from_json("results/exam_data.json")

# 資料統計
print(f"載入 {len(articles)} 條法規")
print(f"載入 {len(questions)} 道題目")
```

---

## 📚 API 參考

### 核心類別

#### `SystemConfig`

```python
# 載入配置
config = SystemConfig.load_from_file("law_config.json")

# 獲取 LLM 配置
llm_config = config.get_llm_config("openai")
```

#### `MappingService`

```python
async with MappingService(config) as service:
    # 初始化 LLM
    await service.initialize_llm("openai")
    
    # 分析單個題目
    mapping = await service.analyze_question(question)
    
    # 批次處理
    mappings = await service.process_questions(limit=10)
    
    # 生成報告
    report = service.generate_report(mappings)
```

#### `DataRepository`

```python
repo = DataRepository(config)

# 存取資料
law_articles = repo.law_articles
exam_questions = repo.exam_questions

# 取得統計
stats = repo.get_stats()
```

### 資料模型

#### `LawArticle`

```python
article = LawArticle(
    law_code="REA-ACT",
    law_name="不動產經紀業管理條例",
    article_no_main=1,
    content="法條內容..."
)

# 屬性
print(article.article_id)    # "REA-ACT-1"
print(article.article_label) # "第1條"
print(article.full_title)   # "不動產經紀業管理條例 第1條"
```

#### `QuestionMapping`

```python
# 對應結果
print(mapping.overall_confidence)      # 0.85
print(mapping.confidence_level.label)  # "高"
print(mapping.primary_article_count)   # 3
print(mapping.success_rate)           # 0.75
```

---

## 🛠️ 故障排除

### 常見問題

#### 1. 模組導入錯誤

```bash
ModuleNotFoundError: No module named 'src'
```

**解決方案**：
```bash
# 確保在專案根目錄執行
cd LegalStatuteAnalysis
python src/main_mapper.py
```

#### 2. API 金鑰錯誤

```bash
OpenAI API 金鑰未設置
```

**解決方案**：
```bash
# 設定環境變數
export OPENAI_API_KEY="your_api_key"

# 或使用 .env 文件
echo "OPENAI_API_KEY=your_api_key" > .env
```

#### 3. 文件路徑錯誤

```bash
FileNotFoundError: 找不到考題資料文件
```

**解決方案**：
```bash
# 檢查文件是否存在
ls results/exam_113_complete_llm_improved.json

# 重新生成考題資料
python scripts/run_llm_parsing.py \
  --questions_file "results/mineru_batch/113190_60150(5601).md" \
  --answers_file "results/mineru_batch/113190_ANS5601.md" \
  --output_file "results/exam_113_complete_llm_improved.json"
```

#### 4. LLM 調用失敗

```bash
LLM 調用失敗: Rate limit exceeded
```

**解決方案**：
```bash
# 使用模擬模式進行測試
python src/main_mapper.py --provider simulation

# 或減少並行處理數量
python src/main_mapper.py --provider openai --limit 5
```

### 日誌分析

系統提供詳細的日誌輸出：

```bash
2025-08-19 12:43:37,147 - INFO - 📊 從 JSON 載入考題資料
2025-08-19 12:43:37,147 - INFO - ✅ 成功載入 27 道考試題目
2025-08-19 12:43:37,147 - INFO -    - 申論題: 2 道
2025-08-19 12:43:37,147 - INFO -    - 選擇題: 25 道
```

### 除錯模式

```bash
# 啟用詳細日誌
export LOG_LEVEL=DEBUG
python src/main_mapper.py --provider simulation --limit 1
```

---

## ✨ 最佳實踐

### 1. 生產環境使用

```bash
# 建議的生產環境設定
python src/main_mapper.py \
  --provider openai \
  --limit 50 \
  --config production_config.json \
  --output "results/analysis_$(date +%Y%m%d_%H%M%S).json"
```

### 2. 成本控制

- 使用 `--limit` 參數控制處理量
- 優先使用 `gpt-4o-mini` 而非 `gpt-4`
- 使用模擬模式進行開發和測試

### 3. 性能優化

- 啟用異步處理（系統預設）
- 使用 SSD 硬碟提高 I/O 性能
- 適當設定 `max_tokens` 參數

### 4. 資料管理

```bash
# 定期備份結果
cp -r results/ backups/results_$(date +%Y%m%d)/

# 清理臨時文件
find results/ -name "test_*.json" -delete
```

### 5. 安全考量

- 不要將 API 金鑰提交到版本控制
- 使用環境變數或 `.env` 文件管理敏感資訊
- 定期輪換 API 金鑰

---

## 📊 系統監控

### 性能指標

系統會自動記錄以下指標：

- **處理時間**：每個題目的分析耗時
- **信心度**：對應結果的可信度
- **成功率**：高信心度結果的比例
- **Token 使用量**：LLM API 的使用統計

### 報告分析

生成的 JSON 報告包含：

```json
{
  "metadata": {
    "total_questions": 27,
    "average_confidence": 0.756,
    "success_rate": 0.741,
    "processing_time_total": 45.2
  },
  "question_mappings": [...]
}
```

---

## 🔄 版本更新

### 檢查版本

```bash
python -c "from src.models import SystemConfig; print(SystemConfig.load_from_file().version)"
```

### 升級流程

1. 備份當前配置和資料
2. 拉取最新代碼
3. 更新依賴：`pip install -r requirements.txt`
4. 檢查配置檔案兼容性
5. 執行測試：`python scripts/test_model_mapper.py`

---

## 📞 技術支援

如遇到問題，請提供以下資訊：

1. **系統版本**：`law_config.json` 中的版本號
2. **錯誤訊息**：完整的錯誤堆疊
3. **執行命令**：使用的完整命令
4. **環境資訊**：Python 版本、作業系統
5. **日誌文件**：相關的系統日誌

---

## 📝 更新日誌

### v3.0 (2025-08-19)
- 重構為資料模型架構
- 新增多 LLM 提供者支援
- 改進異步處理性能
- 完善錯誤處理機制

### v2.4 (之前版本)  
- 基於正則表達式的解析
- 基本 LLM 整合
- CSV 輸出支援

---

**系統開發團隊**  
更新日期：2025年8月19日
